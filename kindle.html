<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Kindle Monitor</title>
    <style>
        body { background-color: white; color: black; font-family: sans-serif; padding: 10px; }
        .termin-card { border: 4px solid black; margin: 15px 0; padding: 10px; }
        .zeit { font-size: 24px; font-weight: bold; text-align: right; border-top: 1px solid black; }
        .urgent { background-color: black; color: white; }
    </style>
</head>
<body>

    <h2 id="status">Lade Daten via Proxy...</h2>
    <div id="liste"></div>

    <script>
        // Wir tunneln die GitHub API durch einen Proxy
        var t1 = "github_pat_11BBRVHCQ05kX9OEirDuF2";
        var t2 = "_SfPbmFFMu5S4O8kX6AdanuVfPsNY6k84nVv35qdNOgAV5OKWJ5NnW3tS9qH";
        var rawUrl = 'https://api.github.com/repos/dacasio/info-board/contents/termine.json';
        
        // Der Proxy-Tunnel
        var proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(rawUrl);

        function holeDaten() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", proxyUrl, true);
            xhr.setRequestHeader("Authorization", "token " + t1 + t2);
            
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        document.getElementById('status').innerHTML = "TERMINE";
                        var response = JSON.parse(xhr.responseText);
                        var jsonString = decodeURIComponent(escape(window.atob(response.content)));
                        var daten = JSON.parse(jsonString);
                        updateAnzeige(daten);
                    } else {
                        document.getElementById('status').innerHTML = "Fehler: " + xhr.status + " (Proxy blocked?)";
                    }
                }
            };
            xhr.send();
        }

        function updateAnzeige(daten) {
            var html = "";
            var jetzt = new Date();
            for (var i = 0; i < daten.length; i++) {
                var t = daten[i];
                var ziel = new Date(t.ziel.replace(' ', 'T'));
                var diff = ziel - jetzt;
                var zeitStr = "HEUTE";
                var urgent = (diff <= 0) ? " urgent" : "";

                if (diff > 0) {
                    var d = Math.floor(diff / 86400000);
                    var h = Math.floor((diff % 86400000) / 3600000);
                    zeitStr = d + "d " + h + "h";
                }

                html += '<div class="termin-card' + urgent + '">';
                html += '<strong>' + t.name + '</strong><br>';
                html += '<small>' + ziel.toLocaleString() + '</small>';
                if (t.notiz) html += '<p>' + t.notiz + '</p>';
                html += '<div class="zeit">' + zeitStr + '</div>';
                html += '</div>';
            }
            document.getElementById('liste').innerHTML = html || "Keine Termine gefunden.";
        }

        holeDaten();
        setInterval(holeDaten, 300000);
    </script>
</body>
</html>
