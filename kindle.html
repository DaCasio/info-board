<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { background-color: white; color: black; font-family: sans-serif; padding: 10px; margin: 0; }
        #status { font-size: 16px; text-align: center; border-bottom: 2px solid black; padding: 5px; margin-bottom: 15px; }
        .card { border: 4px solid black; margin-bottom: 20px; padding: 15px; }
        .name { font-size: 32px; font-weight: bold; display: block; }
        .datum { font-size: 20px; margin: 5px 0; display: block; }
        /* Zeilenumbrüche für Notizen aktivieren */
        .notiz { 
            font-size: 22px; 
            border-top: 2px dashed black; 
            margin-top: 10px; 
            padding-top: 10px; 
            white-space: pre-wrap; 
            word-wrap: break-word;
        }
        .zeit-box { font-size: 38px; font-weight: bold; text-align: right; margin-top: 15px; border-top: 1px solid black; }
        .urgent { background-color: black; color: white; }
        .urgent .notiz { border-top-color: white; }
    </style>
</head>
<body>

    <div id="status">LADE DATEN...</div>
    <div id="liste"></div>

    <script>
        var t1 = "github_pat_11BBRVHCQ05kX9OEirDuF2";
        var t2 = "_SfPbmFFMu5S4O8kX6AdanuVfPsNY6k84nVv35qdNOgAV5OKWJ5NnW3tS9qH";
        var pUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://api.github.com/repos/dacasio/info-board/contents/termine.json');

        function holeDaten() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", pUrl, true);
            xhr.setRequestHeader("Authorization", "token " + t1 + t2);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    try {
                        var res = JSON.parse(xhr.responseText);
                        var content = res.content.replace(/\s/g, '');
                        var json = decodeURIComponent(escape(window.atob(content)));
                        var daten = JSON.parse(json);
                        daten.sort(function(a, b) { return a.ziel < b.ziel ? -1 : 1; });
                        render(daten);
                        var d = new Date();
                        document.getElementById('status').innerHTML = "UPDATE: " + d.getHours() + ":" + (d.getMinutes()<10?'0':'') + d.getMinutes();
                    } catch(e) { document.getElementById('status').innerHTML = "FEHLER: " + e.message; }
                }
            };
            xhr.send();
        }

        function render(daten) {
            var html = "";
            var jetzt = new Date().getTime();

            for (var i = 0; i < daten.length; i++) {
                var t = daten[i];
                var s = t.ziel;
                var j = parseInt(s.substring(0,4), 10);
                var mo = parseInt(s.substring(5,7), 10) - 1;
                var tag = parseInt(s.substring(8,10), 10);
                var h = parseInt(s.substring(11,13), 10);
                var mi = parseInt(s.substring(14,16), 10);
                
                var zD = new Date(j, mo, tag, h, mi, 0);
                var zMs = zD.getTime();
                var diff = Math.floor((zMs - jetzt) / 1000);
                
                var zStr = "FÄLLIG";
                var urg = (diff <= 0) ? " urgent" : "";

                if (diff > 0) {
                    var tg = Math.floor(diff / 86400);
                    var std = Math.floor((diff % 86400) / 3600);
                    var min = Math.floor((diff % 3600) / 60);
                    
                    if (tg > 0) {
                        zStr = tg + " TG " + std + " H";
                    } else {
                        zStr = std + " H " + min + " M";
                    }
                }

                html += '<div class="card' + urg + '">';
                html += '<span class="name">' + t.name + '</span>';
                html += '<span class="datum">' + tag + "." + (mo+1) + ". " + h + ":" + (mi<10?'0':'') + mi + " Uhr</span>";
                if (t.notiz) { html += '<div class="notiz">' + t.notiz + '</div>'; }
                html += '<div class="zeit-box">' + zStr + '</div>';
                html += '</div>';
            }
            document.getElementById('liste').innerHTML = html;
        }

        holeDaten();
        setInterval(holeDaten, 300000);
    </script>
</body>
</html>
